<!DOCTYPE html>
<html>
    <head>
         <style>html {
    background: #123;
    color: #cde;
    font-size: 13pt;
    margin: 2em;
}

.error {
    color: #d65;
}

input, textarea {
    background: #012;
    color: #def;
    font-size: 100%;
}

textarea {
    resize: vertical;
    width: 100%;
    min-height: 2em;
    max-height: 50vh;
}

button {
    background: #627;
    color: #bcd;
    padding: 0.5em;
    cursor: pointer;
    vertical-align: middle;
}

a {
    color: #b7c;
}

#app-title {
    margin: 0;
    float: right;
}

h2 {
    margin: 0.5em 0 0.2em;
}

#output {
    white-space: pre;
    background: #234;
    padding: 1em;
    font-family: monospace;
}

article {
    max-width: 40em;
    margin: 0 auto;
}

.example {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
}

.example > * {
    flex: auto;
    margin: 0.3em;
    display: flex;
    flex-direction: column;
}

.example h5 {
    margin: 0;
}

.example pre {
    background: #0008;
    padding: 0.7em;
    font-size: 90%;
    flex-grow: 1;
    margin-top: 0.5em
}

code {
    background: #0008;
}

dfn {
    background: #323;
}
</style>
        <title>Text Munger</title>
    </head>
    <body>
        <input type="hidden" id="build-date" value="11/28/2021, 12:04:45 AM">
        <main></main>
         <script>(()=>{function ye(a){return a.element instanceof HTMLElement&&typeof a.refs=="object"}var le=class{constructor(t){this.element=t.element,this.refs=t.refs}get classList(){return this.element.classList}get id(){return this.element.id}set id(t){this.element.id=t}get hidden(){return this.element.hidden}set hidden(t){this.element.hidden=t}get innerText(){return this.element.innerText}set innerText(t){this.element.innerText=t}get contenteditable(){return this.element.contentEditable}set contenteditable(t){this.element.contentEditable=t}get spellcheck(){return this.element.spellcheck}set spellcheck(t){this.element.spellcheck=t}get tabIndex(){return this.element.tabIndex}set tabIndex(t){this.element.tabIndex=t}get title(){return this.element.title}set title(t){this.element.title=t}addEventListener(t,n){this.element.addEventListener(t,n)}querySelector(t){return this.element.querySelector(t)}querySelectorAll(t){return this.element.querySelectorAll(t)}focus(t){this.element.focus(t)}blur(){this.element.blur()}};function e(a,t){let n={},i,l;if(typeof a=="function"?i=(l=new a(t)).element:i=document.createElement(a),t?.children){let d=t?.children??[];delete t.children,Array.isArray(d)||(d=[d]);for(let h of d)ye(h)?(Object.assign(n,h.refs),i.append(h.element)):i.append(h)}for(let d in t)d==="ref"?n[t[d]]=l??i:d in i?i[d]=t[d]:i.setAttribute(d,t[d]);return{element:i,refs:n}}var s=e,ke=class extends le{constructor(t){super(e(t.tag??"ul"));this.items=[]}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}get length(){return this.items.length}push(t){this.items.push(t),this.element.appendChild(t.element)}removeAt(t){let n=this.items.splice(t,1);return this.element.removeChild(this.element.children[t]),n[0]}insertAt(t,n){this.items.splice(t,0,n),this.element.insertBefore(n.element,this.element.children[t])}get(t){return this.items[t]}set(t,n){this.items[t]=n,this.element.children[t].replaceWith(n.element)}map(t){let n=[];for(let i=0;i<this.length;i++)n.push(t(this.get(i),i,this));return n}filter(t){let n=[];for(let i=0;i<this.length;i++){let l=this.get(i);t(l)&&n.push(l)}return n}toArray(){return this.map(t=>t)}};function we(a){return a.element instanceof HTMLElement&&typeof a.refs=="object"}var S=class{constructor(t){this.element=t.element,this.refs=t.refs}get classList(){return this.element.classList}get id(){return this.element.id}set id(t){this.element.id=t}get hidden(){return this.element.hidden}set hidden(t){this.element.hidden=t}get innerText(){return this.element.innerText}set innerText(t){this.element.innerText=t}get contenteditable(){return this.element.contentEditable}set contenteditable(t){this.element.contentEditable=t}get spellcheck(){return this.element.spellcheck}set spellcheck(t){this.element.spellcheck=t}get tabIndex(){return this.element.tabIndex}set tabIndex(t){this.element.tabIndex=t}get title(){return this.element.title}set title(t){this.element.title=t}addEventListener(t,n){this.element.addEventListener(t,n)}querySelector(t){return this.element.querySelector(t)}querySelectorAll(t){return this.element.querySelectorAll(t)}focus(t){this.element.focus(t)}blur(){this.element.blur()}};function je(a,t){var n;let i={},l,d;if(typeof a=="function"?l=(d=new a(t)).element:l=document.createElement(a),t==null?void 0:t.children){let h=(n=t==null?void 0:t.children)!==null&&n!==void 0?n:[];delete t.children,Array.isArray(h)||(h=[h]);for(let y of h)we(y)?(Object.assign(i,y.refs),l.append(y.element)):l.append(y)}for(let h in t)h==="ref"?i[t[h]]=d??l:h in l?l[h]=t[h]:l.setAttribute(h,t[h]);return{element:l,refs:i}}var Se=class extends S{constructor(t){var n;super(je((n=t.tag)!==null&&n!==void 0?n:"ul"));this.items=[]}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.get(t)}get length(){return this.items.length}push(t){this.items.push(t),this.element.appendChild(t.element)}removeAt(t){let n=this.items.splice(t,1);return this.element.removeChild(this.element.children[t]),n[0]}insertAt(t,n){this.items.splice(t,0,n),this.element.insertBefore(n.element,this.element.children[t])}get(t){return this.items[t]}set(t,n){this.items[t]=n,this.element.children[t].replaceWith(n.element)}map(t){let n=[];for(let i=0;i<this.length;i++)n.push(t(this.get(i),i,this));return n}filter(t){let n=[];for(let i=0;i<this.length;i++){let l=this.get(i);t(l)&&n.push(l)}return n}toArray(){return this.map(t=>t)}};var P=class{constructor(t){typeof t=="string"?this.instructions=Array.from(t.matchAll(/".*?"|\S+/sg)).map(n=>n[0]):this.instructions=t}evaluate(t,n,i=[]){var l,d,h,y,C,M,k,R,v,w,E,A,b,H;function u(...c){for(let m of c)i.unshift(typeof m=="string"?m:m.toString())}function r(c=0){var m,x;return c===0?(m=i.shift())!==null&&m!==void 0?m:"":(x=i.splice(c,1)[0])!==null&&x!==void 0?x:""}function z(){let c=_.shift();if(!(c instanceof P))throw"Expected proc block, got "+c;return c}function X(){let c=_[0];if(c instanceof P)return _.shift(),c}function J(c){var m;return(m=i[c!=null?c:0])!==null&&m!==void 0?m:""}function Y(c){return!["","0"].includes(c)}let _=this.instructions.slice(),j,L;for(;j=_.shift();){if(j instanceof P)throw Error("Bare proc blocks don't do anything (yet?)");if(/^-?\d+$/.test(j))u(j);else if(j.startsWith('"'))u(JSON.parse(j));else if(L=/^(set|get|push|pop|cons|uncons|join|rev|for|do|getat|setat|inc|dec)\((\w+)\)$/.exec(j))_.unshift(JSON.stringify(L[2]),L[1]);else if(L=/^\$(\d+)$/.exec(j))_.unshift(JSON.stringify(L[1]),"group");else switch(j){case"_":u(t.value);break;case"len":u(r().length);break;case"swap":u(r(),r());break;case"copy":u(J());break;case"drop":r();break;case"clear":i.splice(0);break;case"dump":console.log({instructions:_,stack:i,ctx:n});break;case"i":u(t.index);break;case"group":u((d=(l=t.groups)===null||l===void 0?void 0:l[Number(r())-1])!==null&&d!==void 0?d:"");break;case"max":i.length>=2&&u(Math.max(...[r(),r()].filter(c=>c).map(Number)));break;case"min":i.length>=2&&u(Math.min(...[r(),r()].filter(c=>c).map(Number)));break;case">":u(r(1)>r()?1:0);break;case"<":u(r(1)<r()?1:0);break;case"=":u(r()==r()?1:0);break;case"+":u(Number(r())+Number(r()));break;case"-":u(Number(r(1))-Number(r()));break;case"%":u(Number(r(1))%Number(r()));break;case"*":u(Number(r())*Number(r()));break;case"/":u(Number(r(1))/Number(r()));break;case"rep":u(Array(Number(r())).fill(r()).join(""));break;case"not":u(Number(r())?0:1);break;case"or":{let c=r(1),m=r();u(Y(c)?c:m);break}case"cat":u(r(1)+r());break;case"rpad":u(r(1).padEnd(Number(r())));break;case"lpad":u(r(1).padStart(Number(r())));break;case"index":u(r(1).indexOf(r()));break;case"lower":u(r().toLowerCase());break;case"upper":u(r().toUpperCase());break;case"skip":u(r(1).substring(Number(r())));break;case"take":u(r(1).substring(0,Number(r())));break;case"ord":u((h=r().codePointAt(0))!==null&&h!==void 0?h:0);break;case"chr":u(String.fromCodePoint(Number(r())));break;case"set":n.registers.set(r(),J());break;case"get":u((y=n.registers.get(r()))!==null&&y!==void 0?y:"");break;case"inc":{let c=r();n.registers.set(c,(Number((C=n.registers.get(c))!==null&&C!==void 0?C:0)+1).toString());break}case"dec":{let c=r();n.registers.set(c,(Number((M=n.registers.get(c))!==null&&M!==void 0?M:0)-1).toString());break}case"push":{let c=r();n.arrays.has(c)||n.arrays.set(c,[]),n.arrays.get(c).push(r());break}case"pop":u((R=(k=n.arrays.get(r()))===null||k===void 0?void 0:k.pop())!==null&&R!==void 0?R:"");break;case"cons":{let c=r();n.arrays.has(c)||n.arrays.set(c,[]),n.arrays.get(c).unshift(r());break}case"uncons":u((w=(v=n.arrays.get(r()))===null||v===void 0?void 0:v.shift())!==null&&w!==void 0?w:"");break;case"join":u((A=(E=n.arrays.get(r()))===null||E===void 0?void 0:E.join(r()))!==null&&A!==void 0?A:"");break;case"rev":(b=n.arrays.get(r()))===null||b===void 0||b.reverse();break;case"if":{let c=r(),m=z(),x=X();Y(c)?m.evaluate(t,n,i):x&&x.evaluate(t,n,i);break}case"for":{let c=(H=n.arrays.get(r()))!==null&&H!==void 0?H:[],m=z(),x=0;for(let Z of c)m.evaluate({value:Z,index:x++,groups:[]},n,i);break}case"times":{let c=Number(r()),m=z();for(let x=0;x<c;x++)m.evaluate({value:t.value,index:x,groups:t.groups},n,i);break}case"do":{let c=r(),m=n.mungers.get(c);if(!(m instanceof P))throw Error(`Can't call non-proc name '${c}: ${m}'`);m.evaluate(t,n,i);break}default:throw"unrecognized instruction "+j}}return i.slice().reverse().join("")}};var O;(function(a){a[a.FirstOnly=0]="FirstOnly",a[a.All=1]="All"})(O||(O={}));var Ee=new Map;function $(a,t,n=Ee){let i=a.replace(/\r\n?/g,`
`);return q({value:i,groups:[],index:0},t,{registers:new Map,arrays:new Map,mungers:n})}function q(a,t,n){return typeof t=="string"?t:t instanceof P?t.evaluate(a,n):t.apply(a,n)}var U=class{constructor(t,...n){this.which=t,this.rules=n}apply(t,n){let i=-1,l=0,d=-1,h=[];for(let y=0;l<=t.value.length;++y){let C=this.rules.map((v,w)=>{let E=l;i===E&&w<=w&&++E;let A;if(typeof v.locator=="string"){let b=E>t.value.length?-1:t.value.indexOf(v.locator,E);b>=0&&(A={index:b,value:v.locator,groups:[]})}if(v.locator instanceof RegExp){if(!v.locator.global)throw"gotta be global";v.locator.lastIndex=E;let b=v.locator.exec(t.value);b&&(A={index:b.index,value:b[0],groups:b.slice(1)})}return{index:w,match:A}}).filter(v=>v.match);if(C.length===0)break;let{index:M,match:k}=C.reduce((v,w)=>v.match.index<=w.match.index?v:w);if(!k)break;d=M;let{replace:R}=this.rules[d];if(h.push(t.value.substring(l,k.index),q(k,R,n)),i=k.index,l=k.index+k.value.length,this.which===O.FirstOnly)break}return h.join("")+t.value.substring(l)}repeat(){return new B(this)}},B=class{constructor(t){this.munger=t}apply(t,n){let i=t.value,l=q(t,this.munger,n),d=0;for(;i!==l;)i=l,l=q({value:l,groups:[],index:d++},this.munger,n);return l}},W=class{constructor(t,...n){this.which=t,this.steps=n}apply(t,n){let i=t.value,l=0;for(let d of this.steps){let h=q({value:i,groups:[],index:l++},d,n);if(this.which===O.FirstOnly&&h!==i)return h;i=h}return i}repeat(){return new B(this)}},ne=class{constructor(t){this.rule=t}apply(t,n){let i=t.value,l,d;if(typeof this.rule.locator=="string")d=i.lastIndexOf(this.rule.locator),d>=0&&(l={value:this.rule.locator,groups:[],index:0});else for(let h of i.matchAll(this.rule.locator))d=h.index,l={value:h[0],groups:h.slice(1),index:0};return!l||d==null?i:i.substring(0,d)+q(l,this.rule.replace,n)+i.substring(d+l.value.length)}},ie=class{constructor(t){this.munger=t}apply(t,n){return q(t,this.munger,n),t.value}};var K=class{constructor(t,n,i,l){this.message=t,this.position=n,this.line=i,this.column=l}};function F(a){let t=0,n=/.*/y;function i(o){let p=a.substring(0,t),f=1,T=t+1;for(let N of p.matchAll(/\n/g)){if(N.index==null)throw Error("Internal error: RegExp match doesn't have index");if(N.index>t)break;++f,T=t-N.index+1}console.error(`${f}:${T} `+o),n.lastIndex=t;let D=n.exec(a);throw D&&console.error("Upcoming: "+D[0]),new K(o,t,f,T)}let l=/(?:\s|!.*)+/y;function d(o){var p,f;o.sticky||i(`Token pattern ${o} not sticky.`),l.lastIndex=t,t+=(f=(p=l.exec(a))===null||p===void 0?void 0:p[0].length)!==null&&f!==void 0?f:0,o.lastIndex=t;let T=o.exec(a);if(T)return t+=T[0].length,T}let h=/"(?:[^\\"]|\\.)*"/y;function y(){let o=d(h);if(o)return JSON.parse(o[0])}let C=/'(?:[^\\']|\\.)*'/y;function M(){let o=d(C);if(o)return JSON.parse(o[0].replace(/^'|'$/g,'"'))}let k=/\/((?:[^\\\n/]|\\.)+)\/([ism]*)/y;function R(){let o=d(k);if(o)return new RegExp(o[1],o[2]+"g")}let v=/all/y;function w(){if(!!d(v))return/^.*/gs}function E(){var o,p;return(p=(o=M())!==null&&o!==void 0?o:R())!==null&&p!==void 0?p:w()}let A=/=>/y;function b(){let o=E();if(o==null)return;d(A)||i("Expected '=>'");let p=I();return p==null&&i("Expected rule munger"),{locator:o,replace:p}}function H(){let o=b();if(o!=null)return new U(O.All,o)}let u=/(1)?\(/y,r=/\)/y;function z(){let o=d(u);if(!o)return;let p=[],f;for(;f=b();)p.push(f);return d(r)||i("Expected rule or ')'"),new U(o[1]?O.FirstOnly:O.All,...p)}let X=/(1)?#\(/y,J=/\)/y;function Y(){let o=d(X);if(!o)return;let p=[],f;for(;(f=I())!=null;)p.push(f);return d(J)||i("Expected munger or ')'"),new W(o[1]?O.FirstOnly:O.All,...p)}let _=/{/y,j=/"(?:[^\\"]|\\.)*"|(?:(?!["{}])\S)+/y,L=/}/y;function c(){if(!d(_))return;let o=[],p;for(;;){if(p=d(j)){o.push(p[0]);continue}let f=c();if(f){o.push(f);continue}break}return d(L)||i("Expected instruction or '}'"),new P(o)}let m=/@/y;function x(){if(!d(m))return;let o=I();return o==null&&i("Expected munger after '@' decorator"),new B(o)}let Z=/eat\b/y;function he(){if(!d(Z))return;let o=I();return o==null&&i("Expected munger after 'eat' decorator"),new W(O.All,o,"")}let pe=/fx\b/y;function me(){if(!d(pe))return;let o=I();return o==null&&i("Expected munger after 'fx' decorator"),new ie(o)}let fe=/last\s*\(/y,ve=/\)/y;function ge(){if(!d(fe))return;let o=b();return o==null&&i("Expected rule after 'last('"),d(ve)||i("Expected ')' to close 'last('"),new ne(o)}function I(){var o,p,f,T,D,N,ee,te;return(te=(ee=(N=(D=(T=(f=(p=(o=z())!==null&&o!==void 0?o:Y())!==null&&p!==void 0?p:x())!==null&&f!==void 0?f:ge())!==null&&T!==void 0?T:he())!==null&&D!==void 0?D:me())!==null&&N!==void 0?N:c())!==null&&ee!==void 0?ee:H())!==null&&te!==void 0?te:y()}let be=/def\((\w+)\)/y;function xe(){let o=d(be);if(o==null)return;let p=o[1],f=I();return f==null&&i("Expected munger definition after named declaration"),{name:p,munger:f}}let Q=new Map;for(;;){let o=xe();if(o==null)break;Q.has(o.name)&&i(`Duplicate def() for ${o.name}`),Q.set(o.name,o.munger)}let de=I();return de==null&&i("Expected munger definition"),{munger:de,named:Q}}var G=class extends S{constructor(){super(e("textarea",{spellcheck:!1,onkeydown:t=>this.keydown(t),oninput:()=>this.autosize()},void 0))}get textarea(){return this.element}get value(){return this.textarea.value}set value(t){this.textarea.value=t,this.autosize()}get selectionStart(){return this.textarea.selectionStart}set selectionStart(t){this.textarea.selectionStart=t}get selectionEnd(){return this.textarea.selectionEnd}set selectionEnd(t){this.textarea.selectionEnd=t}keydown(t){if(t.key==="Tab"){t.preventDefault();let n=this.selectionStart;this.value=this.value.substring(0,n)+"	"+this.value.substring(n),this.selectionEnd=this.selectionStart=n+1}}autosize(){this.element.isConnected&&(this.element.style.height="auto",this.element.style.height=this.element.scrollHeight+"px")}};var ce="MungerSource",ae="MungerDoc",re=class extends S{constructor(){super(s("div",{children:[e("h1",Object.assign({ref:"mungeTitle",id:"app-title"},{children:"Text Munge"}),void 0),s("h2",{children:["Munger Source\xA0",e("small",{children:e("a",Object.assign({href:"?docs",target:"_blank"},{children:"?"}),void 0)},void 0)]},void 0),e(G,{ref:"code"},void 0),e("div",{ref:"codeError",class:"error",hidden:!0},void 0),s("h2",{children:["Input Document ",e("button",Object.assign({title:"Ctrl + Enter",onclick:()=>this.munge()},{children:"\u25B6 Munge"}),void 0)]},void 0),e(G,{ref:"input"},void 0),s("div",Object.assign({ref:"outputPanel",hidden:!0},{children:[s("h2",{children:["Output ",e("button",Object.assign({onclick:()=>this.copyOutput()},{children:"\u29C9 Copy"}),void 0)]},void 0),e("div",{ref:"output",id:"output"},void 0)]}),void 0)]},void 0));this.loadState(),this.loadPermaLink(),document.addEventListener("keydown",t=>{t.key==="Enter"&&t.ctrlKey&&this.munge(),t.key==="s"&&t.ctrlKey&&(this.savePermaLink(),t.preventDefault())})}get code(){return this.refs.code}get input(){return this.refs.input}get outputPanel(){return this.refs.outputPanel}get output(){return this.refs.output}mounted(){this.code.autosize(),this.input.autosize()}copyOutput(){let t=document.createRange();t.selectNodeContents(this.output);let n=getSelection();n&&(n.removeAllRanges(),n.addRange(t)),navigator.clipboard.writeText(this.refs.output.innerText)}saveState(){localStorage.setItem(ce,this.code.value),localStorage.setItem(ae,this.input.value)}loadState(){let t=localStorage.getItem(ce);t&&(this.code.value=t);let n=localStorage.getItem(ae);n&&(this.input.value=n)}codeChanged(){this.refs.codeError.hidden=!0}munge(){this.saveState();try{let t=F(this.code.value);this.refs.codeError.hidden=!0;let n=$(this.input.value,t.munger,t.named);this.refs.output.innerText=n,this.refs.outputPanel.hidden=!1}catch(t){t instanceof K?(this.refs.codeError.innerText=`${t.line}:${t.column} ${t.message}`,this.code.focus(),this.code.selectionStart=t.position,this.code.selectionEnd=t.position+1):this.refs.codeError.innerText=t==null?void 0:t.toString(),this.refs.codeError.hidden=!1;return}}savePermaLink(){let t=btoa(JSON.stringify({m:this.code.value,i:this.input.value}));location.hash="#"+t}loadPermaLink(){try{let t=JSON.parse(atob(location.hash.substring(1)));this.code.value=t.m,this.input.value=t.i}catch(t){console.error(t)}}};var{munger:ue}=F(`
#( ! dedent
	/^(\\s*\\n)+/ => ""
	fx /^\\s+/m => { get(indent) _ len min set(indent) }
	/.+/ => { _ get(indent) skip }
)`),g=class extends S{constructor(t){super(s("div",{children:[e("h4",{children:"Example"},void 0),s("div",Object.assign({class:"example"},{children:[s("div",{children:[e("h5",{children:"Input"},void 0),e("pre",{ref:"input"},void 0)]},void 0),s("div",{children:[e("h5",{children:"Munger"},void 0),e("pre",{ref:"munger"},void 0)]},void 0),s("div",{children:[e("h5",{children:"Output"},void 0),e("pre",{ref:"output"},void 0)]},void 0)]}),void 0)]},void 0));let n=$(t.input,ue);this.refs.input.innerText=n,this.refs.munger.innerText=$(t.munger,ue);let{munger:i,named:l}=F(t.munger);this.refs.output.innerText=$(n,i,l)}};var oe=class extends S{constructor(){super(s("article",{children:[e("h1",{children:"Text Munge Docs"},void 0),s("section",{children:[e("p",{children:"Munging is about manipulating text."},void 0),s("ol",{children:[e("li",{children:"You have an input document as a string."},void 0),e("li",{children:"You apply a munger."},void 0),e("li",{children:"You get an output document as a string."},void 0)]},void 0),e("p",{children:"A simple munger might extract email addresses. A fancy munger could convert CSV to JSON. Some things work better than others. Let's look at an example."},void 0),e(g,{input:"Hello world",munger:'/o/ => "u"'},void 0),e("h2",Object.assign({id:"munger"},{children:"Mungers"}),void 0),s("p",{children:["A ",e("dfn",{children:"munger"},void 0)," takes text as input. Some can optionally take other context information as well. It produces text as output. There are several types of mungers."]},void 0),s("ul",{children:[e("li",{children:e("a",Object.assign({href:"#rule"},{children:"Rule"}),void 0)},void 0),e("li",{children:e("a",Object.assign({href:"#ruleset"},{children:"Ruleset"}),void 0)},void 0),e("li",{children:e("a",Object.assign({href:"#literal"},{children:"String"}),void 0)},void 0),e("li",{children:e("a",Object.assign({href:"#repeater"},{children:"Repeater"}),void 0)},void 0),e("li",{children:e("a",Object.assign({href:"#effects"},{children:"Side-effect decorator"}),void 0)},void 0),e("li",{children:e("a",Object.assign({href:"#last"},{children:"Last decorator"}),void 0)},void 0),e("li",{children:e("a",Object.assign({href:"#proc"},{children:"Proc"}),void 0)},void 0)]},void 0)]},void 0),e("h2",Object.assign({id:"rule"},{children:"Rules"}),void 0),e("section",{children:s("p",{children:["A ",e("dfn",{children:"rule"},void 0)," consists of a locator and a munger. They go in that order with ",e("code",{children:"=>"},void 0)," in between them."]},void 0)},void 0),e("h2",Object.assign({id:"locator"},{children:"Locator"}),void 0),s("section",{children:[s("p",{children:["A ",e("dfn",{children:"locator"},void 0)," finds some particular substring of the input to manipulate. There are two kinds.  For now. The simplest locator is the literal. It's enclosed in single quotes."]},void 0),e(g,{input:`Once you munge,
you never go back`,munger:`' ' => ""`},void 0),s("p",{children:["There are also regular expression locators, using mostly javascript syntax. The ",e("code",{children:"ism"},void 0)," flags are supported. The ",e("code",{children:"g"},void 0)," flag is implied.",e("code",{children:"all"},void 0)," is shorthand for ",e("code",{children:"/.*/s"},void 0),"."]},void 0),e(g,{input:"abc 123 def 456",munger:'/\\d/ => "_"'},void 0)]},void 0),e("h2",Object.assign({id:"literal"},{children:"Literal"}),void 0),s("section",{children:[s("p",{children:["A ",e("dfn",{children:"literal munger"},void 0)," is the simplest type of munger. It's a string literal in double quotes. Single quotes are for locators. Double quotes are for mungers. At the top level, this is generally useless. Check out this example.  Every input becomes the same output."]},void 0),e(g,{input:"whatever, a bunch of text",munger:'"useless"'},void 0)]},void 0),e("h2",Object.assign({id:"ruleset"},{children:"Rulesets"}),void 0),s("section",{children:[s("p",{children:["A ",e("dfn",{children:"ruleset"},void 0)," consists of one or more rules. By default, they are applied in document order. Munging proceeds from beginning to end of the input document. Matching rules are applied for each match encountered. A default ruleset consists of zero or more rules contained in ",e("code",{children:"( [rules here] )"},void 0),". An empty set of parenthesis is a no-op munger, which is occasionally useful."]},void 0),e(g,{input:`
                            1. abc
                            2. ab
                            3. bc`,munger:`
                            (
                                'ab' => "X"
                                'bc' => "Y"
                            )`},void 0)]},void 0),e("h2",Object.assign({id:"first"},{children:"First-only rulesets"}),void 0),s("section",{children:[s("p",{children:["There are a couple of ways to change the behavior of a ruleset. A ",e("dfn",{children:"first-only ruleset"},void 0)," only applies the the first rule that matches, scanning in document order. After that rule is applied, no further munging is performed. First-only rulesets are expressed by adding a preceding 1: ",e("code",{children:"1( [rules here] )"},void 0)]},void 0),e(g,{input:"foo foo foo",munger:`1( 'foo' => "bar" )`},void 0)]},void 0),e("h2",Object.assign({id:"sequence"},{children:"Sequences"}),void 0),s("section",{children:[s("p",{children:["A ",e("dfn",{children:"sequence"},void 0)," is an orderd list of mungers. Rather than scanning the document from start to end, a sequence iterates over rules in declaration order. It applies each munger to the entire document in declaration order. This means that subsequent mungers are able to see the output from the previous rules. These use a ",e("code",{children:"#"},void 0)," prefix."]},void 0),e(g,{input:"food",munger:`
                        #( 
                            'foo' => "bar"
                            'ard' => "icycle"
                        )`},void 0),s("p",{children:["It's also possible to combine a sequenced and first-only ruleset this way. These apply only the first rule to match, in declaration order, instead of document order.  The prefix is ",e("code",{children:"1#"},void 0),"."]},void 0)]},void 0),e("h2",Object.assign({id:"repeater"},{children:"Repeaters"}),void 0),s("section",{children:[s("p",{children:["A ",e("dfn",{children:"repeater"},void 0)," is a decorated munger. You can preced any other munger with a ",e("code",{children:"@"},void 0),", and it will become a repeater. The at symbol looks like a wheel to me, just rolling and rolling. A repeater applies repeatedly to its input until a fixed point is reached. It's not too hard to make an infinite loop with these."]},void 0),e(g,{input:"a{{}{{}}}b",munger:`@'{}' => ""`},void 0)]},void 0),e("h2",Object.assign({id:"last"},{children:"Last match"}),void 0),s("section",{children:[s("p",{children:["You can apply a rule only to the last match of its locator using a ",e("dfn",{children:"last"},void 0),". This can only be applied to a single rule."]},void 0),e(g,{input:"foo foo foo",munger:`last('foo' => "bar")`},void 0)]},void 0),e("h2",Object.assign({id:"comment"},{children:"Comments"}),void 0),s("section",{children:[s("p",{children:["You can add a ",e("dfn",{children:"comment"},void 0)," to the end of any line in a munger. Comments start with a ",e("code",{children:"!"},void 0),"."]},void 0),e(g,{input:"loool             ",munger:'/\\s+$/ => "" ! trailing whitespace'},void 0)]},void 0),e("h2",Object.assign({id:"proc"},{children:"Procs"}),void 0),s("section",{children:[s("p",{children:["Now it's time for the big guns. A ",e("dfn",{children:"proc"},void 0)," is an arbitrary piece of logic inside of ",e("code",{children:"{ }"},void 0)," curly braces. It's a concatenative stack-based language fully enclosed inside the text munging language. Ok, let's just look at some code."]},void 0),e(g,{input:"Hello World",munger:`
                            ( ! toggle case
                                /[a-z]/ => { _ upper }
                                /[A-Z]/ => { _ lower }
                            )`},void 0),s("p",{children:["There's a ",e("a",Object.assign({target:"_blank",href:"?proc"},{children:"whole separate page"}),void 0)," about the details of the proc language."]},void 0)]},void 0),e("h2",Object.assign({id:"effects"},{children:"Side effects"}),void 0),s("section",{children:[s("p",{children:["There's a ",e("dfn",{children:"side effect"},void 0)," decoration you can use on any munger if you only want to use it for side effects. This is generally most useful if you have procs that are setting variables or something that you're going to use later. Preced any munger with `fx`, and it won't actually do any replacement."]},void 0),e(g,{input:`
                            first
                            middle
                            last`,munger:`
                            #( !last shall be first
                                fx /.+/ => { _ len set(lastlen) }
                                1( /$/m => { " Length of last line: " get(lastlen) } )
                            )`},void 0)]},void 0),e("h2",Object.assign({id:"named"},{children:"Named munger declarations"}),void 0),s("section",{children:[s("p",{children:["Prior to the munger, you can create one or more ",e("dfn",{children:"named munger declarations"},void 0),". These can be referred to later. These are ",e("code",{children:"def(name)"},void 0)," followed by a munger."]},void 0),e(g,{input:"abc123def567",munger:`
                            def(paren) { "(" _ ")" }
                            ( ! enclose runs in parens
                                /\\d+/     => { do(paren) }
                                /[a-z]+/i => { do(paren) }
                            )`},void 0)]},void 0),s("p",{children:["Did you know?  You can press ",e("kbd",{children:"Ctrl"},void 0)," + ",e("kbd",{children:"S"},void 0)," to generate a permalink."]},void 0)]},void 0))}};var se=class extends S{constructor(){super(s("article",{children:[e("h1",{children:"Munging Procs"},void 0),s("p",{children:["Procs operate on a stack.  All values are strings. Some instructions operate on numbers, but they're really just strings like ",e("code",{children:'"123"'},void 0),". There are two spaces for named variables. One for normal string variables, and another for arrays of strings."]},void 0),e("p",{children:"A proc is just one type of munger.  All mungers produce a single string as output. At the conclusion of a proc, all the values in the stack are concatenated together to produce the output."},void 0),s("p",{children:["Certain noted instructions operate on blocks. Blocks are groups of instructions enclosed in curly braces. ",e("code",{children:"{ }"},void 0),"Blocks can be nested."]},void 0),e("h2",{children:"Proc Instructions"},void 0),s("dl",{children:[e("dt",{children:e("code",{children:"_"},void 0)},void 0),e("dd",{children:"Push the current matched value."},void 0),e("dt",{children:e("code",{children:'"abc"'},void 0)},void 0),e("dd",{children:"Push a string literal."},void 0),e("dt",{children:e("code",{children:"123"},void 0)},void 0),e("dd",{children:"Push a string literal consisting of digits."},void 0),e("dt",{children:e("code",{children:"$1"},void 0)},void 0),e("dd",{children:"Push the value of the first capture group from a regex locator. Works for other numbers too."},void 0),e("dt",{children:e("code",{children:"group"},void 0)},void 0),e("dd",{children:"Push the value of the nth capture group from a regex locator. n is popped."},void 0),e("dt",{children:e("code",{children:"swap"},void 0)},void 0),e("dd",{children:"Swap the top two values on the stack."},void 0),e("dt",{children:e("code",{children:"copy"},void 0)},void 0),e("dd",{children:"Copy the top value on the stack."},void 0),e("dt",{children:e("code",{children:"drop"},void 0)},void 0),e("dd",{children:"Pop from the stack and throw it in the trash."},void 0),e("dt",{children:e("code",{children:"clear"},void 0)},void 0),e("dd",{children:"Empty the whole stack."},void 0),e("dt",{children:e("code",{children:"len"},void 0)},void 0),e("dd",{children:"Push the length of a string."},void 0),e("dt",{children:e("code",{children:"i"},void 0)},void 0),e("dd",{children:"Push the iteration index.  There are a few iteration contexts."},void 0),e("dt",{children:e("code",{children:"min"},void 0)},void 0),e("dt",{children:e("code",{children:"max"},void 0)},void 0),e("dd",{children:"Pop two values.  Push the lesser or greater of them, interpreted as numbers."},void 0),e("dt",{children:e("code",{children:"<"},void 0)},void 0),e("dt",{children:e("code",{children:">"},void 0)},void 0),e("dt",{children:e("code",{children:"="},void 0)},void 0),e("dd",{children:"Pop two values.  Push 0 or 1 depending on the comparison of the two."},void 0),e("dt",{children:e("code",{children:"+"},void 0)},void 0),e("dt",{children:e("code",{children:"-"},void 0)},void 0),e("dt",{children:e("code",{children:"*"},void 0)},void 0),e("dt",{children:e("code",{children:"/"},void 0)},void 0),e("dt",{children:e("code",{children:"%"},void 0)},void 0),e("dd",{children:"Pop two values.  Push the result of an arithmetic operation."},void 0),e("dt",{children:e("code",{children:"not"},void 0)},void 0),e("dd",{children:"Pop a value.  Push 0 if it's truthy, or 1 otherwise."},void 0),e("dt",{children:e("code",{children:"rep"},void 0)},void 0),e("dd",{children:"Pop a repetition count.  Concatenate a popped string that many times."},void 0),e("dt",{children:e("code",{children:"or"},void 0)},void 0),e("dd",{children:"Pop two values. Push the first one if it's truthy.  Otherwise push the second."},void 0),e("dt",{children:e("code",{children:"cat"},void 0)},void 0),e("dd",{children:"Pop a value, then concatenate with the top of the stack"},void 0),e("dt",{children:e("code",{children:"lpad"},void 0)},void 0),e("dt",{children:e("code",{children:"rpad"},void 0)},void 0),e("dd",{children:"Pop a width.  Left- or right-pad a value to the specified width."},void 0),e("dt",{children:e("code",{children:"index"},void 0)},void 0),e("dd",{children:"Pop two values.  Push the index of the first occurrence of the second in the first."},void 0),e("dt",{children:e("code",{children:"upper"},void 0)},void 0),e("dt",{children:e("code",{children:"lower"},void 0)},void 0),e("dd",{children:"Pop a value.  Convert the case and push."},void 0),e("dt",{children:e("code",{children:"take"},void 0)},void 0),e("dt",{children:e("code",{children:"skip"},void 0)},void 0),e("dd",{children:"Pop an index.  Push the left or right substring of a value from that position."},void 0),e("dt",{children:e("code",{children:"ord"},void 0)},void 0),e("dt",{children:e("code",{children:"chr"},void 0)},void 0),e("dd",{children:"Convert between a character and the corresponding unicode codepoint."},void 0),e("dt",{children:e("code",{children:"set(x)"},void 0)},void 0),e("dt",{children:e("code",{children:"get(x)"},void 0)},void 0),e("dd",{children:"Gets or sets a named variable."},void 0),e("dt",{children:e("code",{children:"inc(x)"},void 0)},void 0),e("dt",{children:e("code",{children:"dec(x)"},void 0)},void 0),e("dd",{children:"Increment or decrement a named variable.  Does not touch the stack."},void 0),e("dt",{children:e("code",{children:"cons(x)"},void 0)},void 0),e("dt",{children:e("code",{children:"push(x)"},void 0)},void 0),e("dd",{children:"Pop a value.  Insert it at the beginning or end of a named array."},void 0),e("dt",{children:e("code",{children:"uncons(x)"},void 0)},void 0),e("dt",{children:e("code",{children:"pop(x)"},void 0)},void 0),e("dd",{children:"Push a value removed from the beginning or end of a named array."},void 0),e("dt",{children:e("code",{children:"rev(x)"},void 0)},void 0),e("dd",{children:"Reverse a named array in place.  Does not touch the stack."},void 0),e("dt",{children:e("code",{children:"join(x)"},void 0)},void 0),e("dd",{children:"Pop a delimiter.  Use it to join a named array.  Push the result."},void 0),e("dt",{children:s("code",{children:["if ","{ ... } [{ ... }]"]},void 0)},void 0),e("dd",{children:"Pop a condition.  If it's truthy, execute the following condition block.  Otherwise execute the else block, if present."},void 0),e("dt",{children:s("code",{children:["for(x) ","{ ... }"]},void 0)},void 0),s("dd",{children:["Execute a block for each element in a named array.  The element will be accessible from the ",e("code",{children:"_"},void 0)," instruction."]},void 0),e("dt",{children:s("code",{children:["times ","{ ... }"]},void 0)},void 0),e("dd",{children:"Pop a number.  Execute a block that many times."},void 0),e("dt",{children:e("code",{children:"do(x)"},void 0)},void 0),s("dd",{children:["Invoke a named proc, established using a ",e("code",{children:"def(x)"},void 0)," declaration."]},void 0),e("dt",{children:e("code",{children:"dump"},void 0)},void 0),e("dd",{children:"Logs the current state of things to the console."},void 0)]},void 0),e("h2",{children:"Parting Example"},void 0),e("p",{children:"Here's a fancy little number that demonstrates many of these. It indents JSON."},void 0),e(g,{input:`
                        { "kind": "Combobox", "defaultValue": "win-x86", 
                        "label": { "$ref": "strings:#/targetRuntime" }, 
                        "itemsSource": { "kind": "TargetRuntime", "defaults": 
                        [ "win-x86", "win-x64", "win-arm", "osx-x64", 
                        "linux-x64", "linux-arm" ], "dependsOn": [ 
                        "DeploymentMode.SelectedValue" ] }, "enabled": 
                        "true" }`,munger:`
                        def(nl) {                 ! macro definition for next line
                            "\\n"
                            "  " get(depth) rep   ! repeat indent string
                        }
                        (
                            /\\s/ => ""            ! strip pre-existing whitespace
                            /"(?:\\\\.|.)*?"/ => () ! don't touch string literals
                            ':' => ": "           ! single space after colon
                            ',' => { _ do(nl) }   ! newline after comma
                            /{|\\[/ => {           ! open braces
                                inc(depth)
                                _ do(nl)
                            }
                            /}|\\]/ => {           ! close braces
                                dec(depth)
                                do(nl) _ 
                            }
                        )`},void 0)]},void 0))}};var V=document.querySelector("main");switch(location.search){case"?docs":let a=new oe;V.append(a.element);break;case"?proc":let t=new se;V.append(t.element);break;case"?about":V.append("Text Munger by Tom Theisen");break;default:let n=new re;n.refs.mungeTitle.title=document.getElementById("build-date").value,V.append(n.element),n.mounted()}})();
</script>
    </body>
</html>