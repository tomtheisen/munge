<!DOCTYPE html>
<html>
    <head>
         <style>body {
    background: #123;
    color: #abc;
    font-family: sans-serif;
    margin: 1em;
}

.error {
    color: #d65;
}
</style>
    </head>
    <body>
        <div id="app"></div>
         <script>(()=>{function de(a){return a.element instanceof HTMLElement&&typeof a.refs=="object"}var Z=class{constructor(e){this.element=e.element,this.refs=e.refs}get hidden(){return this.element.hidden}set hidden(e){this.element.hidden=e}get innerText(){return this.element.innerText}set innerText(e){this.element.innerText=e}get classList(){return this.element.classList}addEventListener(e,t){this.element.addEventListener(e,t)}};function k(a,e){let t={},n,o;if(typeof a=="function"?n=(o=new a(e)).element:n=document.createElement(a),e?.children){let s=e?.children??[];delete e.children,Array.isArray(s)||(s=[s]);for(let c of s)de(c)?(Object.assign(t,c.refs),n.append(c.element)):n.append(c)}for(let s in e)s==="ref"?t[e[s]]=o??n:s in n?n[s]=e[s]:n.setAttribute(s,e[s]);return{element:n,refs:t}}var K=k,fe=class extends Z{constructor(e){super(k(e.tag??"ul"));this.items=[]}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}get length(){return this.items.length}push(e){this.items.push(e),this.element.appendChild(e.element)}removeAt(e){let t=this.items.splice(e,1);return this.element.removeChild(this.element.children[e]),t[0]}insertAt(e,t){this.items.splice(e,0,t),this.element.insertBefore(t.element,this.element.children[e])}get(e){return this.items[e]}set(e,t){this.items[e]=t,this.element.children[e].replaceWith(t.element)}map(e){let t=[];for(let n=0;n<this.length;n++)t.push(e(this.get(n),n,this));return t}filter(e){let t=[];for(let n=0;n<this.length;n++){let o=this.get(n);e(o)&&t.push(o)}return t}toArray(){return this.map(e=>e)}};function pe(a){return a.element instanceof HTMLElement&&typeof a.refs=="object"}var F=class{constructor(e){this.element=e.element,this.refs=e.refs}get hidden(){return this.element.hidden}set hidden(e){this.element.hidden=e}get innerText(){return this.element.innerText}set innerText(e){this.element.innerText=e}get classList(){return this.element.classList}addEventListener(e,t){this.element.addEventListener(e,t)}};function me(a,e){var t;let n={},o,s;if(typeof a=="function"?o=(s=new a(e)).element:o=document.createElement(a),e==null?void 0:e.children){let c=(t=e==null?void 0:e.children)!==null&&t!==void 0?t:[];delete e.children,Array.isArray(c)||(c=[c]);for(let b of c)pe(b)?(Object.assign(n,b.refs),o.append(b.element)):o.append(b)}for(let c in e)c==="ref"?n[e[c]]=s??o:c in o?o[c]=e[c]:o.setAttribute(c,e[c]);return{element:o,refs:n}}var he=class extends F{constructor(e){var t;super(me((t=e.tag)!==null&&t!==void 0?t:"ul"));this.items=[]}*[Symbol.iterator](){for(let e=0;e<this.length;e++)yield this.get(e)}get length(){return this.items.length}push(e){this.items.push(e),this.element.appendChild(e.element)}removeAt(e){let t=this.items.splice(e,1);return this.element.removeChild(this.element.children[e]),t[0]}insertAt(e,t){this.items.splice(e,0,t),this.element.insertBefore(t.element,this.element.children[e])}get(e){return this.items[e]}set(e,t){this.items[e]=t,this.element.children[e].replaceWith(t.element)}map(e){let t=[];for(let n=0;n<this.length;n++)t.push(e(this.get(n),n,this));return t}filter(e){let t=[];for(let n=0;n<this.length;n++){let o=this.get(n);e(o)&&t.push(o)}return t}toArray(){return this.map(e=>e)}};var T=class{constructor(e){typeof e=="string"?this.instructions=Array.from(e.matchAll(/".*?"|\S+/sg)).map(t=>t[0]):this.instructions=e}evaluate(e,t,n=[]){var o,s,c,b,_,C,v,j,m,y,E,N,h,I;function u(...l){for(let f of l)n.unshift(typeof f=="string"?f:f.toString())}function r(l=0){var f,g;return l===0?(f=n.shift())!==null&&f!==void 0?f:"":(g=n.splice(l,1)[0])!==null&&g!==void 0?g:""}function $(){let l=O.shift();if(!(l instanceof T))throw"Expected proc block, got "+l;return l}function W(){let l=O[0];if(l instanceof T)return O.shift(),l}function B(l){var f;return(f=n[l!=null?l:0])!==null&&f!==void 0?f:""}function D(l){return!["","0"].includes(l)}let O=this.instructions.slice(),x,L;for(;x=O.shift();){if(x instanceof T)throw Error("Bare proc blocks don't do anything (yet?)");if(/^-?\d+$/.test(x))u(x);else if(x.startsWith('"'))u(JSON.parse(x));else if(L=/^(set|get|push|pop|cons|uncons|join|rev|for|do|getat|setat|inc|dec)\((\w+)\)$/.exec(x))O.unshift(JSON.stringify(L[2]),L[1]);else if(L=/^\$(\d+)$/.exec(x))O.unshift(JSON.stringify(L[1]),"group");else switch(x){case"_":u(e.value);break;case"nl":u(`
`);break;case"len":u(r().length);break;case"swap":u(r(),r());break;case"copy":u(B());break;case"drop":r();break;case"clear":n.splice(0);break;case"dump":console.log({instructions:O,stack:n,ctx:t});break;case"i":u(e.index);break;case"group":u((s=(o=e.groups)===null||o===void 0?void 0:o[Number(r())-1])!==null&&s!==void 0?s:"");break;case"max":n.length>=2&&u(Math.max(Number(r()),Number(r())));break;case"min":n.length>=2&&u(Math.min(Number(r()),Number(r())));break;case">":u(r(1)>r()?1:0);break;case"<":u(r(1)<r()?1:0);break;case"=":u(r()==r()?1:0);break;case"+":u(Number(r())+Number(r()));break;case"-":u(Number(r(1))-Number(r()));break;case"%":u(Number(r(1))%Number(r()));break;case"*":u(Number(r())*Number(r()));break;case"/":u(Number(r(1))/Number(r()));break;case"rep":u(Array(Number(r())).fill(r()).join(""));break;case"not":u(Number(r())?0:1);break;case"or":{let l=r(1),f=r();u(D(l)?l:f);break}case"cat":u(r(1)+r());break;case"rpad":u(r(1).padEnd(Number(r())));break;case"lpad":u(r(1).padStart(Number(r())));break;case"index":u(r(1).indexOf(r()));break;case"lower":u(r().toLowerCase());break;case"upper":u(r().toUpperCase());break;case"skip":u(r(1).substring(Number(r())));break;case"take":u(r(1).substring(0,Number(r())));break;case"ord":u((c=r().codePointAt(0))!==null&&c!==void 0?c:0);break;case"chr":u(String.fromCodePoint(Number(r())));break;case"set":t.registers.set(r(),B());break;case"get":u((b=t.registers.get(r()))!==null&&b!==void 0?b:"");break;case"inc":{let l=r();t.registers.set(l,(Number((_=t.registers.get(l))!==null&&_!==void 0?_:0)+1).toString());break}case"dec":{let l=r();t.registers.set(l,(Number((C=t.registers.get(l))!==null&&C!==void 0?C:0)-1).toString());break}case"push":{let l=r();t.arrays.has(l)||t.arrays.set(l,[]),t.arrays.get(l).push(r());break}case"pop":u((j=(v=t.arrays.get(r()))===null||v===void 0?void 0:v.pop())!==null&&j!==void 0?j:"");break;case"cons":{let l=r();t.arrays.has(l)||t.arrays.set(l,[]),t.arrays.get(l).unshift(r());break}case"uncons":u((y=(m=t.arrays.get(r()))===null||m===void 0?void 0:m.shift())!==null&&y!==void 0?y:"");break;case"join":u((N=(E=t.arrays.get(r()))===null||E===void 0?void 0:E.join(r()))!==null&&N!==void 0?N:"");break;case"rev":(h=t.arrays.get(r()))===null||h===void 0||h.reverse();break;case"if":{let l=r(),f=$(),g=W();D(l)?f.evaluate(e,t,n):g&&g.evaluate(e,t,n);break}case"for":{let l=(I=t.arrays.get(r()))!==null&&I!==void 0?I:[],f=$(),g=0;for(let q of l)f.evaluate({value:q,index:g++,groups:[]},t,n);break}case"times":{let l=Number(r()),f=$();for(let g=0;g<l;g++)f.evaluate({value:e.value,index:g,groups:e.groups},t,n);break}case"do":{let l=r(),f=t.mungers.get(l);if(!(f instanceof T))throw Error(`Can't call non-proc name '${l}: ${f}'`);f.evaluate(e,t,n);break}default:throw"unrecognized instruction "+x}}return n.slice().reverse().join("")}};var w;(function(a){a[a.FirstOnly=0]="FirstOnly",a[a.All=1]="All"})(w||(w={}));function ee(a,e,t){let n=a.replace(/\r\n?/g,`
`);return A({value:n,groups:[],index:0},e,{registers:new Map,arrays:new Map,mungers:t})}function A(a,e,t){return typeof e=="string"?e:e instanceof T?e.evaluate(a,t):e.apply(a,t)}var J=class{constructor(e,...t){this.which=e,this.rules=t}apply(e,t){let n=-1,o=0,s=-1,c=[];for(let b=0;o<=e.value.length;++b){let _=this.rules.map((m,y)=>{let E=o;n===E&&y<=y&&++E;let N;if(typeof m.locator=="string"){let h=E>e.value.length?-1:e.value.indexOf(m.locator,E);h>=0&&(N={index:h,value:m.locator,groups:[]})}if(m.locator instanceof RegExp){if(!m.locator.global)throw"gotta be global";m.locator.lastIndex=E;let h=m.locator.exec(e.value);h&&(N={index:h.index,value:h[0],groups:h.slice(1)})}return{index:y,match:N}}).filter(m=>m.match);if(_.length===0)break;let{index:C,match:v}=_.reduce((m,y)=>m.match.index<=y.match.index?m:y);if(!v)break;s=C;let{replace:j}=this.rules[s];if(c.push(e.value.substring(o,v.index),A(v,j,t)),n=v.index,o=v.index+v.value.length,this.which===w.FirstOnly)break}return c.join("")+e.value.substring(o)}repeat(){return new H(this)}},H=class{constructor(e){this.munger=e}apply(e,t){let n=e.value,o=A(e,this.munger,t),s=0;for(;n!==o;)n=o,o=A({value:o,groups:[],index:s++},this.munger,t);return o}},U=class{constructor(e,...t){this.which=e,this.steps=t}apply(e,t){let n=e.value,o=0;for(let s of this.steps){let c=A({value:n,groups:[],index:o++},s,t);if(this.which===w.FirstOnly&&c!==n)return c;n=c}return n}repeat(){return new H(this)}},Q=class{constructor(e){this.rule=e}apply(e,t){let n=e.value,o,s;if(typeof this.rule.locator=="string")s=n.lastIndexOf(this.rule.locator),s>=0&&(o={value:this.rule.locator,groups:[],index:0});else for(let c of n.matchAll(this.rule.locator))s=c.index,o={value:c[0],groups:c.slice(1),index:0};return!o||s==null?n:n.substring(0,s)+A(o,this.rule.replace,t)+n.substring(s+o.value.length)}},V=class{constructor(e){this.munger=e}apply(e,t){return A(e,this.munger,t),e.value}};function te(a){let e=0,t=/.*/y;function n(i){let d=a.substring(0,e),p=1,S=1;for(let M of d.matchAll(/\n/g)){if(M.index==null)throw Error("Internal error: RegExp match doesn't have index");if(M.index>e)break;++p,S=e-M.index+1}console.error(`${p}:${S} `+i),t.lastIndex=e;let P=t.exec(a);P&&console.error("Upcoming: "+P[0]),process.exit(1)}let o=/(?:\s|!.*)+/y;function s(i){var d,p;i.sticky||n(`Token pattern ${i} not sticky.`),o.lastIndex=e,e+=(p=(d=o.exec(a))===null||d===void 0?void 0:d[0].length)!==null&&p!==void 0?p:0,i.lastIndex=e;let S=i.exec(a);if(S)return e+=S[0].length,S}let c=/"(?:[^\\"]|\\.)*"/y;function b(){let i=s(c);if(i)return JSON.parse(i[0])}let _=/'(?:[^\\']|\\.)*'/y;function C(){let i=s(_);if(i)return JSON.parse(i[0].replace(/^'|'$/g,'"'))}let v=/\/((?:[^\\\n/]|\\.)+)\/([ism]*)/y;function j(){let i=s(v);if(i)return new RegExp(i[1],i[2]+"g")}let m=/all/y;function y(){if(!!s(m))return/^.*/gs}function E(){var i,d;return(d=(i=C())!==null&&i!==void 0?i:j())!==null&&d!==void 0?d:y()}let N=/=>/y;function h(){let i=E();if(i==null)return;s(N)||n("Expected '=>'");let d=R();return d==null&&n("Expected rule munger"),{locator:i,replace:d}}function I(){let i=h();if(i!=null)return new J(w.All,i)}let u=/(1)?\(/y,r=/\)/y;function $(){let i=s(u);if(!i)return;let d=[],p;for(;p=h();)d.push(p);return s(r)||n("Expected rule or ')'"),new J(i[1]?w.FirstOnly:w.All,...d)}let W=/(1)?#\(/y,B=/\)/y;function D(){let i=s(W);if(!i)return;let d=[],p;for(;(p=R())!=null;)d.push(p);return s(B)||n("Expected munger or ')'"),new U(i[1]?w.FirstOnly:w.All,...d)}let O=/{/y,x=/"(?:[^\\"]|\\.)*"|(?:(?!["{}])\S)+/y,L=/}/y;function l(){if(!s(O))return;let i=[],d;for(;;){if(d=s(x)){i.push(d[0]);continue}let p=l();if(p){i.push(p);continue}break}return s(L)||n("Expected instruction or '}'"),new T(i)}let f=/@/y;function g(){if(!s(f))return;let i=R();return i==null&&n("Expected munger after '@' decorator"),new H(i)}let q=/eat\b/y;function re(){if(!s(q))return;let i=R();return i==null&&n("Expected munger after 'eat' decorator"),new U(w.All,i,"")}let ie=/fx\b/y;function se(){if(!s(ie))return;let i=R();return i==null&&n("Expected munger after 'fx' decorator"),new V(i)}let oe=/last\s*\(/y,le=/\)/y;function ae(){if(!s(oe))return;let i=h();return i==null&&n("Expected rule after 'last('"),s(le)||n("Expected ')' to close 'last('"),new Q(i)}function R(){var i,d,p,S,P,M,G,X;return(X=(G=(M=(P=(S=(p=(d=(i=$())!==null&&i!==void 0?i:D())!==null&&d!==void 0?d:g())!==null&&p!==void 0?p:ae())!==null&&S!==void 0?S:re())!==null&&P!==void 0?P:se())!==null&&M!==void 0?M:l())!==null&&G!==void 0?G:I())!==null&&X!==void 0?X:b()}let ue=/def\((\w+)\)/y;function ce(){let i=s(ue);if(i==null)return;let d=i[1],p=R();return p==null&&n("Expected munger definition after named declaration"),{name:d,munger:p}}let z=new Map;for(;;){let i=ce();if(i==null)break;z.has(i.name)&&n(`Duplicate def() for ${i.name}`),z.set(i.name,i.munger)}let Y=R();return Y==null&&n("Expected munger definition"),{munger:Y,named:z}}var ne=class extends F{constructor(){super(K("div",{children:[k("h1",{children:"Hello mungees"},void 0),k("h2",{children:"Munging Code"},void 0),k("textarea",{ref:"code"},void 0),k("div",{ref:"codeError",class:"error",hidden:!0},void 0),k("h2",{children:"Input Document"},void 0),k("textarea",{ref:"input"},void 0),k("button",Object.assign({onclick:()=>this.munge()},{children:"Munge me"}),void 0),K("div",Object.assign({ref:"outputPanel",hidden:!0},{children:[k("h2",{children:"Output"},void 0),k("div",{ref:"output"},void 0)]}),void 0)]},void 0))}get code(){return this.refs.code}get input(){return this.refs.input}munge(){try{let e=te(this.code.value);this.refs.codeError.hidden=!0;let t=ee(this.input.value,e.munger,e.named);this.refs.output.innerText=t,this.refs.outputPanel.hidden=!1}catch(e){this.refs.codeError.innerText=e==null?void 0:e.toString(),this.refs.codeError.hidden=!1;return}}},ge=new ne;document.getElementById("app").append(ge.element);})();
</script>
        <template><script></script></template>
    </body>
</html>